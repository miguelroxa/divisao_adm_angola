<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPA - Divisão Político-Administrativa de Angola</title>
    
    <link rel="stylesheet" href="./leaflet/leaflet.css" />

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        /* CORREÇÃO ESTÉTICA 1: Títulos */
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #124b89; /* Azul Escuro */
            font-size: 28px;
            margin-bottom: 5px;
        }
        .subtitulo-lei {
            color: #666;
            font-size: 14px;
            font-style: italic;
            margin-top: 0;
        }

        .container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            flex: 1;
            padding: 20px;
            background-color: #ffffff; /* Fundo Branco */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .map-container {
            flex: 2;
            height: 600px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #124b89;
        }
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: #fff;
        }
        select:disabled {
            background-color: #e9ecef;
            color: #777;
        }
        .status-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ef; /* Verde Claro Suave */
            border: 1px solid #b3e0c0;
            border-left: 5px solid #00a651; /* Verde Ângola */
            border-radius: 4px;
        }
        .status-box p {
            margin: 5px 0;
            line-height: 1.4;
        }
        .status-box strong {
            color: #007044;
        }
        .capital {
            font-style: italic;
            color: #555;
        }
        /* Estilo para garantir que o mapa Leaflet ocupe todo o div */
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <header>
        <h1>Divisão Político-Administrativa de Angola</h1>
        <p class="subtitulo-lei">Lei n.º 14/24 de 5 de Setembro (21 Províncias)</p>
    </header>

    <div class="container">
        
        <div class="controls">
            <h2>Seleção de Localidade</h2>

            <label for="provincia">Província:</label>
            <select id="provincia">
                <option value="">A carregar...</option>
            </select>

            <label for="municipio">Município:</label>
            <select id="municipio" disabled>
                <option value="">Selecione primeiro a Província</option>
            </select>

            <label for="comuna">Comuna:</label>
            <select id="comuna" disabled>
                <option value="">Selecione primeiro o Município</option>
            </select>

            <div id="status-display" class="status-box">
                <p>Aguarde o carregamento dos dados DPA...</p>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script src="./leaflet/leaflet.js"></script>

    <script>
        // ****************************************************
        // CONFIGURAÇÃO CRÍTICA DO LEAFLET (Para o ícone carregar)
        // O Leaflet por vezes não encontra o caminho padrão para as imagens (marker-icon.png)
        // ****************************************************
        if (typeof L !== 'undefined') {
            // VERIFIQUE SE O CAMINHO './leaflet/images/' ESTÁ CORRETO NO SEU PC
            L.Icon.Default.imagePath = './leaflet/images/';
        }
        
        // Função utilitária para formatar para Title Case - CORRIGIDA PARA PORTUGUÊS
        function toTitleCase(str) {
            if (!str) return str;
            const exceptions = ['e', 'do', 'da', 'dos', 'das', 'de', 'a', 'o', 'as', 'os', 'no', 'na', 'nos', 'nas', 'por', 'com', 'sem', 'em', 'um', 'uma', 'de'];

            return str.toLowerCase().split(/[\s-]/).map(function(word, index) {
                if (word.length === 0) return word;
                
                if (index > 0 && exceptions.includes(word)) {
                    return word;
                }
                
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }
        
        // ****************************************************
        // DADOS DPA (21 Províncias) - FINAL E CORRIGIDO
        // ****************************************************
        // (O JSON DPA_JSON_STRING não foi alterado e é o mesmo da resposta anterior)
        const DPA_JSON_STRING = '{"Bengo":{"Municipios":{"Bula Atumba":["Bula Atumba","Quiage"],"Dande":["Caxito","Mabubas","Quicabo"],"Quibaxe":["Coxe","Paredes","Quibaxe"],"Nambuangongo":["Canacassala","Gombe","Zala"],"Pango Aluem":["Pango Aluem","Cazuangongo"],"Ambriz":["Ambriz","Bela Vista","Tabi"],"Muxaluando":["Muxaluando","Quixico","Cage Mazumbo"],"Piri":["Piri"],"Quicunzo":["Quicunzo"],"Ucua":["Ucua"],"Panguila":["Panguila"],"Barra Do Dande":["Barra Do Dande"]}},"Benguela":{"Municipios":{"Baia Farta":["Baia Farta"],"Balombo":["Balombo","Maca Mombolo"],"Bocoio":["Bocoio","Cubal Do Lumbo","Monte Belo"],"Caimbambo":["Caimbambo","Caiave","Viangombe"],"Catumbela":["Catumbela"],"Chongoroi":["Chongoroi","Camuine"],"Cubal":["Cubal"],"Ganda":["Ganda"],"Lobito":["Lobito"],"Benguela":["Benguela"],"Egito Praia":["Egito Praia","Canjala"],"Chindumbo":["Chindumbo"],"Dombe Grande":["Dombe Grande"],"Capupa":["Capupa"],"Biopio":["Biopio"],"Chila":["Chila"],"Chicuma":["Chicuma"],"Babaera":["Babaera"],"Iambala":["Iambala"],"Catengue":["Catengue"],"Bolonguera":["Bolonguera"],"Canhamela":["Canhamela"],"Navegantes":["Navegantes"]}},"Bie":{"Municipios":{"Andulo":["Andulo","Cassumbe","Chivaulo"],"Camacupa":["Camacupa","Cuanza","Muinha"],"Catabola":["Catabola","Caiuera","Sande"],"Chinguar":["Chinguar","Cutato","Cangote"],"Chitembo":["Chitembo","Cachingues","Malengue"],"Cuemba":["Cuemba","Munhango","Sachinemuna"],"Cuito":["Cuito","Cunje"],"Cunhinga":["Cunhinga"],"Nharea":["Nharea","Gamba","Caieie"],"Luando":["Luando"],"Ringoma":["Ringoma"],"Mumbue":["Mumbue","Mutumbo","Soma Cuanza"],"Calucinga":["Calucinga"],"Chicala":["Chicala"],"Chipeta":["Chipeta","Chiuca"],"Umpulo":["Umpulo"],"Lubia":["Lubia","Dando"],"Cambandua":["Cambandua"],"Belo Horizonte":["Belo Horizonte"]}},"Cabinda":{"Municipios":{"Belize":["Luali","Belize"],"Buco-Zau":["Buco-Zau"],"Cabinda":["Cabinda"],"Cacongo":["Dinge","Landana"],"Miconje":["Miconje"],"Massabi":["Massabi"],"Necuto":["Necuto","Inhuca"],"Tando Zinze":["Tando Zinze","Malembo"],"Liambo":["Liambo"],"Ngoio":["Ngoio"]}},"Cuando":{"Municipios":{"Cuito Cuanavale":["Cuito Cuanavale","Lupire"],"Dirico":["Dirico","Xamavera"],"Mavinga":["Mavinga"],"Rivungo":["Rivungo"],"Xipundo":["Xipundo"],"Dima":["Cunjamba","Cutuile"],"Luiana":["Luiana"],"Mucusso":["Mucusso"],"Luengue":["Luengue"]}},"Cubango":{"Municipios":{"Calai":["Calai"],"Cuangar":["Cuangar"],"Cuchi":["Cuchi"],"Cutato":["Cutato","Vissati"],"Caiundo":["Caiundo","Jamba Cueio"],"Longa":["Longa","Baixo Longa"],"Menongue":["Menongue"],"Nancova":["Nancova","Rito"],"Savate":["Savate","Bondo Caila"],"Chinguanja":["Chinguanja"]}},"Cuanza Norte":{"Municipios":{"Ambaca":["Camabatela","Maua","Bindo"],"Banga":["Banga","Cariamba"],"Bolongongo":["Bolongongo"],"Cambambe":["Dondo","Dange Ya Menha","Sao Pedro Da Quilemba"],"Cazengo":["Caculo Camuiza","Ndalatando"],"Golungo Alto":["Golungo Alto","Cambondo","Quilombo Quia Puto"],"Lucala":["Lucala","Quiangombe"],"Ngonguembo":["Quilombo Dos Dembos","Camame","Cavunga"],"Quiculungo":["Quiculungo"],"Samba Caju":["Samba Caju","Samba Lucala"],"Massangano":["Massangano","Zenza Do Itombe"],"Cerca":["Cerca"],"Tango":["Tango"],"Terreiro":["Terreiro","Quiquiemba"],"Aldeia Nova":["Aldeia Nova"],"Caculo Cabaca":["Caculo Cabaca"],"Luinga":["Luinga"]}},"Cuanza Sul":{"Municipios":{"Gabela":["Gabela","Assango"],"Cassongue":["Cassongue","Atome","Dumbi"],"Waku Kungo":["Waku Kungo"],"Conda":["Cunjo","Conda"],"Ebo":["Ebo","Cassanje"],"Calulo":["Calulo","Cabuta"],"Mussende":["Mussende","Quipaxi"],"Porto Amboim":["Porto Amboim","Capolo"],"Quibala":["Quibala","Dala Cachibo"],"Quilenda":["Quilenda"],"Seles":["Seles","Botera"],"Sumbe":["Sumbe","Quicombo"],"Quirimbo":["Quirimbo"],"Munenga":["Munenga"],"Quissongo":["Quissongo"],"Gungo":["Gungo"],"Sanga":["Sanga"],"Gangula":["Gangula"],"Pambangala":["Pambangala"],"Conde":["Conde"],"Amboiva":["Amboiva"],"Lonhe":["Lonhe","Cariango"],"Quenha":["Quenha"],"Boa Entrada":["Boa Entrada"]}},"Cunene":{"Municipios":{"Cahama":["Cahama","Otchinjau"],"Cuanhama":["Ondjiva","Mongua"],"Curoca":["Curoca"],"Cuvelai":["Cuvelai"],"Namacunde":["Namacunde"],"Ombandja":["Xangongo","Ombala Yo Mungu"],"Chiede":["Chiede"],"Nehone":["Nehone","Evale"],"Humbe":["Mucope","Humbe"],"Mupa":["Mupa"],"Naulila":["Naulila"],"Chitado":["Chitado"],"Cafima":["Cafima"],"Chissuata":["Chissuata"]}},"Huambo":{"Municipios":{"Bailundo":["Bailundo","Lunge","Luvemba"],"Caala":["Caala"],"Cachiungo":["Chinhama","Cachiungo"],"Chicala Choloanga":["Mbave","Chicala"],"Chinjenje":["Chinjenje","Chiaca"],"Ecunha":["Ecunha","Quipeio"],"Huambo":["Huambo","Calima"],"Londuimbali":["Londuimbali","Ussoque"],"Longonjo":["Longonjo","Lepi"],"Mungo":["Mungo","Cambuengo"],"Ucuma":["Ucuma","Cacoma","Mundundo"],"Bimbe":["Bimbe","Hengue"],"Sambo":["Sambo","Samboto"],"Galanga":["Galanga","Cumbira"],"Alto Hama":["Alto Hama"],"Chilata":["Chilata"],"Cuima":["Cuima","Catata"]}},"Huila":{"Municipios":{"Caconda":["Caconda","Gungue","Uaba","Cusse"],"Cacula":["Cacula","Tchicuaqueia"],"Caluquembe":["Caluquembe","Calepi","Negola"],"Chibia":["Chibia","Jau"],"Chicomba":["Chicomba","Cutenda"],"Chipindo":["Chipindo","Bambi"],"Cuvango":["Cuvango"],"Gambos":["Chiange","Chimbemba"],"Humpata":["Humpata"],"Jamba Mineira":["Cassinga","Jamba Mineira"],"Lubango":["Lubango","Huila"],"Matala":["Matala"],"Quilengues":["Quilengues","Impulo","Dinde"],"Quipungo":["Quipungo"],"Dongo":["Dongo"],"Hoque":["Hoque"],"Capelongo":["Capelongo","Mulondo"],"Chituto":["Chituto"],"Capunda Cavilongo":["Capunda Cavilongo","Quihita"],"Viti Vivali":["Viti Vivali"],"Galangue":["Galangue"],"Palanca":["Palanca"],"Chicungo":["Chicungo"]}},"Icolo E Bengo":{"Municipios":{"Catete":["Catete","Cassoneca","Caculo Cahango","Caxicane"],"Quicama":["Muxima","Quixinge","Demba Chio","Mumbondo"],"Calumbo":["Calumbo"],"Cabiri":["Cabiri"],"Cabo Ledo":["Cabo Ledo"],"Bom Jesus":["Bom Jesus"],"Sequele":["Funda","Quifangondo","Sequele"]}},"Luanda":{"Municipios":{"Belas":["Benfica","Cabolombo","Barra Do Cuanza","Ramiros"],"Cacuaco":["Cacuaco","Kikolo"],"Cazenga":["Cazenga","Kima Kieza"],"Kilamba Kiaxi":["Golfe","Nova Vida"],"Viana":["Viana"],"Mussulo":["Mussulo"],"Sambizanga":["Sambizanga"],"Rangel":["Rangel"],"Maianga":["Maianga"],"Samba":["Samba"],"Camama":["Camama"],"Mulenvos":["Mulenvos"],"Kilamba":["Kilamba","Vila Flor"],"Hoji Ya Henda":["Hoji Ya Henda"],"Ingombota":["Ingombota"],"Talatona":["Talatona"]}},"Lunda Norte":{"Municipios":{"Cambulo":["Cachimo","Nzage"],"Capenda Camulemba":["Capenda Camulemba","Xinge"],"Caungula":["Caungula"],"Chitato":["Chitato"],"Cuango":["Cuango"],"Cuilo":["Caluango","Cuilo"],"Lubalo":["Muvuluege","Lubalo"],"Lucapa":["Camissombo","Lucapa"],"Lovua":["Lovua"],"Xa-Muteba":["Xa-Muteba"],"Dundo":["Dundo","Luachimo"],"Xa Cassau":["Xa Cassau","Capaia"],"Camaxilo":["Camaxilo"],"Luangue":["Luangue"],"Luremo":["Luremo"],"Canzar":["Canzar","Luia"],"Cassanje Calucala":["Cassanje Calucala","Iongo"],"Mussungue":["Mussungue","Caita"],"Cafunfu":["Cafunfu"]}},"Lunda Sul":{"Municipios":{"Cacolo":["Cacolo"],"Dala":["Dala"],"Muconda":["Muconda"],"Saurimo":["Mona Quimbundo","Saurimo"],"Chiluage":["Chiluage"],"Cassai-Sul":["Cassai-Sul"],"Xassengue":["Xassengue","Cucumbi"],"Alto Chicapa":["Alto Chicapa"],"Sombo":["Sombo"],"Muriege":["Muriege"],"Luma Cassai":["Luma Cassai"],"Cazage":["Cazage"],"Muangueji":["Muangueji"],"Cassengo":["Cassengo"]}},"Malanje":{"Municipios":{"Cacuso":["Cacuso","Soqueco"],"Cahombo":["Cahombo","Micanda"],"Calandula":["Calandula","Cota"],"Cambundi Catembo":["Cambundi Catembo","Dumba Cambango"],"Cangandala":["Cangandala","Caribo","Culamagia"],"Kiwaba Nzoji":["Kiwaba Nzoji","Mufuma"],"Kunda Dya Baze":["Kunda Dya Baze","Lemba"],"Luquembo":["Luquembo","Dombo Wa Zanga"],"Malanje":["Malanje","Lombe"],"Marimba":["Marimba","Mangando"],"Massango":["Massango"],"Quela":["Quela","Bangalas"],"Quirima":["Quirima","Sautar"],"Cateco Cangola":["Cateco Cangola"],"Cuale":["Cuale"],"Pungo A Ndongo":["Pungo A Ndongo"],"Ngola Luiji":["Ngola Luiji","Cambaxe"],"Quihuhu":["Quihuhu","Quinguengue"],"Xandel":["Xandel","Moma"],"Cambo Suingingue":["Cambo Suingingue","Milando"],"Quitapa":["Quitapa"],"Capunda":["Capunda","Quimbango","Cunga Palanga"],"Muquixe":["Muquixe"],"Quessua":["Quessua"],"Caculama":["Caculama","Caxinga"],"Mbanji Ya Ngola":["Mbanji Ya Ngola","Cabombo"]}},"Moxico":{"Municipios":{"Chiume":["Chiume"],"Lumbala Nguimbo":["Lumbala Nguimbo","Mussuma Mitete","Sessa"],"Camanongue":["Camanongue"],"Leua":["Leua","Liangongo"],"Alto Cuito":["Alto Cuito"],"Lutembo":["Lutembo","Luvuei"],"Cangumbe":["Cangumbe"],"Luena":["Luena","Cassongo"],"Cangamba":["Cangombe","Cassamba","Cangamba","Muie"],"Lucusse":["Lucusse"],"Ninda":["Ninda"],"Lutuai":["Lutuai"]}},"Moxico Leste":{"Municipios":{"Cazombo":["Cazombo","Lumbala Caquengue"],"Luacano":["Luacano"],"Cameia":["Cameia"],"Luau":["Luau"],"Nana Candundo":["Nana Candundo"],"Macondo":["Macondo","Calunda"],"Caianda":["Caianda"],"Lovua Do Zambeze":["Lovua Do Zambeze"],"Lago Dilolo":["Lago Dilolo"]}},"Namibe":{"Municipios":{"Mocamedes":["Mocamedes"],"Camucuio":["Camucuio","Mamue","Chingo"],"Bibala":["Bibala","Capangombe","Caitou","Lola"],"Virei":["Virei","Cainde"],"Tombua":["Tombua"],"Lucira":["Lucira","Bentiaba"],"Iona":["Iona"],"Sacomar":["Sacomar"],"Cacimbas":["Cacimbas"]}},"Uige":{"Municipios":{"Uige":["Uige","Luanga","Casseche","Cancungo"],"Cangola":["Cangola","Bengo","Caiongo"],"Ambuila":["Ambuila"],"Bembe":["Bembe","Mabaia"],"Nova Esperanca":["Nova Esperanca","Buenga - Sul","Cuilo Camboso"],"Bungo":["Bungo"],"Milunga":["Milunga","Macocola"],"Damba":["Damba","Petecusso","Camatambo","Lemboa"],"Maquela Do Zombo":["Maquela Do Zombo","Quibocolo"],"Mucaba":["Mucaba","Uando Mucaba"],"Negage":["Negage","Dimuca","Quisseque"],"Puri":["Puri"],"Quimbele":["Quimbele","Icoca"],"Dange Quitexe":["Quitexe","Aldeia Vicosa"],"Sanza Pombo":["Sanza Pombo","Cuilo Pombo","Uamba","Alfandega"],"Songo":["Songo","Quivuenga"],"Sacandica":["Sacandica","Cuilo Futa","Beu"],"Nsosso":["Nsosso"],"Lucunga":["Lucunga"],"Quipedro":["Quipedro"],"Massau":["Massau","Macolo"],"Vista Alegre":["Vista Alegre","Cambamba"],"Alto Zaza":["Alto Zaza","Cuango Calumbo"]}},"Zaire":{"Municipios":{"Mbanza Congo":["Mbanza Congo","Caluca","Madimba","Quiende"],"Soyo":["Soyo","Pedra De Feitico"],"Nzeto":["Nzeto","Musserra","Quibala Norte"],"Cuimba":["Cuimba","Buela","Luvaca"],"Noqui":["Mpala"],"Tomboco":["Tomboco","Quinsimba","Quinzau"],"Luvo":["Luvo"],"Lufico":["Lufico"],"Quelo":["Quelo"],"Serra De Canda":["Serra De Canda"],"Quindeje":["Quibala - Norte","Quindeje"]}}}';

        // Tabela de Capitais com coordenadas (Latitude, Longitude) - VERSÃO ESTÁVEL E FINAL
        // O marcador do mapa irá SEMPRE para estas coordenadas.
        const CAPITAIS_COORDENADAS = {
            "Bengo": [-8.5772, 13.6425], "Benguela": [-12.5714, 13.4078], "Bie": [-12.1603, 16.9381], "Cabinda": [-5.5684, 12.1932],
            "Cuando": [-15.7900, 20.3650], "Cubango": [-14.6592, 18.0678], 
            "Cuanza Norte": [-9.35, 14.9167], "Cuanza Sul": [-11.205, 13.8447], "Cunene": [-17.0667, 15.7333],
            "Huambo": [-12.7761, 15.7397], "Huila": [-14.9244, 13.4844], 
            "Icolo E Bengo": [-9.1114, 13.6875], 
            "Luanda": [-8.8368, 13.2343],
            "Lunda Norte": [-7.3753, 20.8228], "Lunda Sul": [-9.6603, 20.3958], "Malanje": [-10.85, 16.7333], 
            "Moxico": [-11.7892, 19.9192], 
            "Moxico Leste": [-11.9056, 22.2158], 
            "Namibe": [-15.2167, 12.15], "Uige": [-7.6156, 15.0436], "Zaire": [-6.2625, 14.2483],

            // Adição de Coordenadas de algumas Capitais de Município (Opcional, mas melhora a experiência)
            "Mavinga": [-15.828, 19.957], // Quando Cubango (Município)
            "Catete": [-9.1114, 13.6875], // Icolo e Bengo (Município)
            "Cazombo": [-11.9056, 22.2158], // Moxico Leste (Município)
            "Lobito": [-12.35, 13.55], // Benguela (Município)
            "Soyo": [-6.133, 12.375], // Zaire (Município)
            "Dondo": [-9.683, 14.417] // Cuanza Norte (Município)
            // ...poderia adicionar mais aqui, mas estas são as principais capitais de município
        };

        // Tabela de Capitais (Nomes limpos)
        const CAPITAIS_PROVINCIAS = {
            "Bengo": "Caxito", "Benguela": "Benguela", "Bie": "Cuito", "Cabinda": "Cabinda",
            "Cuando": "Mavinga", "Cubango": "Menongue", "Cuanza Norte": "Ndalatando", 
            "Cuanza Sul": "Sumbe", "Cunene": "Ondjiva", "Huambo": "Huambo", "Huila": "Lubango", 
            "Icolo E Bengo": "Catete", "Luanda": "Luanda", "Lunda Norte": "Dundo", 
            "Lunda Sul": "Saurimo", "Malanje": "Malanje", "Moxico": "Luena", 
            "Moxico Leste": "Cazombo", "Namibe": "Mocamedes", "Uige": "Uige", "Zaire": "Mbanza Congo" 
        };

        // Variáveis Globais
        let DPA_OFFICIAL = {};
        let map = null; 
        let marker = null; 
        
        // Referências aos elementos SELECT
        const selectProvincia = document.getElementById('provincia');
        const selectMunicipio = document.getElementById('municipio');
        const selectComuna = document.getElementById('comuna');
        const statusDisplay = document.getElementById('status-display');
        
        // ----------------------------------------------------------------------
        // LÓGICA DO MAPA
        // ----------------------------------------------------------------------

        function initMap() {
            if (typeof L === 'undefined') {
                statusDisplay.innerHTML = '<p style="color:red; font-weight:bold;">ERRO CRÍTICO: Biblioteca Leaflet (mapa) não foi detetada. Por favor, verifique se os ficheiros `leaflet.css` e `leaflet.js` estão na pasta `leaflet/`.</p>';
                return;
            }

            const luandaCoords = [-8.8368, 13.2343]; 
            map = L.map('map').setView(luandaCoords, 6); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 18
            }).addTo(map);

            marker = L.marker(luandaCoords).addTo(map)
                .bindPopup("<b>Angola</b><br>Luanda").openPopup();
                
            map.invalidateSize(); 
        }

        /**
         * Move o mapa para a coordenada mais detalhada possível (Comuna/Município/Capital).
         */
        function updateMap() {
            if (!map) return;
            
            const selectedProvincia = selectProvincia.value;
            const selectedMunicipio = selectMunicipio.value;
            const selectedComuna = selectComuna.value;

            let targetName = CAPITAIS_PROVINCIAS[selectedProvincia]; // Nome padrão (Capital)
            let currentCoords = CAPITAIS_COORDENADAS[selectedProvincia]; // Coordenada padrão (Capital)
            let popupText = "";
            let zoomLevel = 7;
            let tipo = "Capital da Província";

            if (!selectedProvincia) {
                 map.flyTo([-8.8368, 13.2343], 6);
                 return;
            }


            // 1. Tentar localizar o Município (se houver uma coordenada estática definida)
            if (selectedMunicipio) {
                // Tenta usar a coordenada estática do Município, se existir na nossa lista
                if (CAPITAIS_COORDENADAS[selectedMunicipio]) {
                    targetName = selectedMunicipio;
                    currentCoords = CAPITAIS_COORDENADAS[selectedMunicipio];
                    zoomLevel = 8;
                } else {
                    // Usa a coordenada da Capital, mas com zoom maior para dar ideia de localização
                    zoomLevel = 8;
                }
            }

            // 2. Tentar localizar a Comuna (se houver uma coordenada estática definida)
            // Nota: Comunas têm poucas coordenadas, por isso geralmente caem no Município/Capital
            if (selectedComuna) {
                 // Tenta usar a coordenada estática da Comuna, se existir na nossa lista
                if (CAPITAIS_COORDENADAS[selectedComuna]) {
                    targetName = selectedComuna;
                    currentCoords = CAPITAIS_COORDENADAS[selectedComuna];
                    zoomLevel = 9;
                } else {
                    // Usa a coordenada do Município ou Capital mais próxima
                    zoomLevel = 9;
                }
            }
            
            // 3. Define o texto do pop-up
            if (selectedComuna) {
                popupText = `<b>Comuna:</b> ${toTitleCase(selectedComuna)}<br>Município: ${toTitleCase(selectedMunicipio)}<br>Província: ${toTitleCase(selectedProvincia)}`;
                tipo = "Comuna";
            } else if (selectedMunicipio) {
                popupText = `<b>Município:</b> ${toTitleCase(selectedMunicipio)}<br>Província: ${toTitleCase(selectedProvincia)}`;
                tipo = "Município";
            } else {
                popupText = `<b>Capital da Província:</b> ${toTitleCase(CAPITAIS_PROVINCIAS[selectedProvincia])}<br>Província: ${toTitleCase(selectedProvincia)}`;
                tipo = "Capital";
            }
            
            // 4. Mover o mapa e o marcador
            const [lat, lng] = currentCoords;
            map.flyTo([lat, lng], zoomLevel); 

            if (marker) {
                marker.setLatLng([lat, lng]);
                marker.setPopupContent(popupText).openPopup();
            } else {
                marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(popupText).openPopup();
            }

            // Atualiza o painel de status
            atualizarStatus(selectedProvincia, selectedMunicipio, selectedComuna);
        }
        
        // ----------------------------------------------------------------------
        // LÓGICA DOS SELECTORES E STATUS
        // ----------------------------------------------------------------------

        function popularProvincias() {
             // ... (função popularProvincias inalterada)
            selectProvincia.innerHTML = '<option value="">Selecione a Província</option>'; 
            if (Object.keys(DPA_OFFICIAL).length === 0) return;

            const provincias = Object.keys(DPA_OFFICIAL).sort(); 
            provincias.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = toTitleCase(nome); 
                selectProvincia.appendChild(option);
            });
            
            statusDisplay.className = 'status-box';
            statusDisplay.innerHTML = `<p><strong>SUCESSO:</strong> Foram carregadas ${provincias.length} Províncias (21 DPA). Selecione uma.</p>`;
        }
        
        function popularMunicipios(provincia) {
            // ... (função popularMunicipios inalterada)
            selectMunicipio.innerHTML = '<option value="">Selecione o Município</option>';
            selectComuna.innerHTML = '<option value="">Selecione a Comuna</option>';
            selectComuna.disabled = true;

            if (provincia && DPA_OFFICIAL[provincia]) {
                const municipios = DPA_OFFICIAL[provincia].Municipios;
                Object.keys(municipios).sort().forEach(nome => {
                    const option = document.createElement('option');
                    option.value = nome;
                    option.textContent = toTitleCase(nome); 
                    selectMunicipio.appendChild(option);
                });
                selectMunicipio.disabled = false;
            } else {
                selectMunicipio.disabled = true;
            }
        }

        function popularComunas(provincia, municipio) {
            // ... (função popularComunas inalterada)
            selectComuna.innerHTML = '<option value="">Selecione a Comuna</option>';

            if (provincia && municipio && DPA_OFFICIAL[provincia].Municipios[municipio]) {
                const comunas = DPA_OFFICIAL[provincia].Municipios[municipio];
                comunas.sort().forEach(nome => {
                    const option = document.createElement('option');
                    option.value = nome;
                    option.textContent = toTitleCase(nome); 
                    selectComuna.appendChild(option);
                });
                selectComuna.disabled = comunas.length === 0;
            } else {
                selectComuna.disabled = true;
            }
        }

        function atualizarStatus(provincia, municipio = null, comuna = null) {
            // ... (função atualizarStatus inalterada)
            if (!provincia) {
                statusDisplay.innerHTML = '<p>Selecione uma **Província** no menu acima.</p>';
                return;
            }

            const capital = CAPITAIS_PROVINCIAS[provincia] || "Não Definida";
            
            let localizacao = `<strong>Província:</strong> ${toTitleCase(provincia)}<br><span class="capital">Capital: ${toTitleCase(capital)}</span>`;
            let nivel = 'Província';

            if (municipio) {
                localizacao += `<br><strong>Município:</strong> ${toTitleCase(municipio)}`;
                nivel = 'Município';
            }
            if (comuna) {
                localizacao += `<br><strong>Comuna:</strong> ${toTitleCase(comuna)}`;
                nivel = 'Comuna';
            }
            
            statusDisplay.innerHTML = `<p><strong>Nível Selecionado:</strong> ${nivel}</p><p>${localizacao}</p>`;
        }
        
        // Eventos
        function eventProvincia(event) {
            const selectedProvincia = event.target.value;
            popularMunicipios(selectedProvincia);
            selectComuna.innerHTML = '<option value="">Selecione a Comuna</option>';
            selectComuna.disabled = true;
            updateMap();
        }

        function eventMunicipio(event) {
            const selectedProvincia = selectProvincia.value;
            const selectedMunicipio = event.target.value;
            popularComunas(selectedProvincia, selectedMunicipio);
            updateMap();
        }
        
        function eventComuna(event) {
            updateMap();
        }
        
        // ****************************************************
        // INICIALIZAÇÃO
        // ****************************************************
        (function() {
            try {
                DPA_OFFICIAL = JSON.parse(DPA_JSON_STRING);
                popularProvincias();
                initMap();
                
                selectProvincia.addEventListener('change', eventProvincia);
                selectMunicipio.addEventListener('change', eventMunicipio);
                selectComuna.addEventListener('change', eventComuna);
                
            } catch (e) {
                statusDisplay.innerHTML = `<p><strong>ERRO CRÍTICO (JS):</strong> Falha na execução do código principal.</p><p>Detalhe do Erro: ${e.message}</p>`;
                statusDisplay.style.borderColor = 'red';
                statusDisplay.style.backgroundColor = '#ffe6e6';
                console.error("ERRO FATAL NA EXECUÇÃO DO SCRIPT:", e);
            }
        })();
        
    </script>
</body>
</html>
